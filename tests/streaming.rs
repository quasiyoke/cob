use futures::stream;

use order_book::snapshots;

#[tokio::test]
fn snapshots_are_being_updated() {
    static MESSAGES: &[&[u8]] = &[
        br#"
    {
        "type":"Snapshot",
        "payload":{
           "instrument":{
              "symbol":{
                 "type":"Spot",
                 "payload":{
                    "base":{
                       "code":"BTC"
                    },
                    "quote":{
                       "code":"USDT"
                    }
                 }
              },
              "exchange":"KUCOIN_SPOT"
           },
           "bids":[
              {
                 "price":"23431.1",
                 "size":"2.39566067"
              },
              {
                 "price":"23431",
                 "size":"0.01323805"
              },
              {
                 "price":"23430.9",
                 "size":"0.00283734"
              },
              {
                 "price":"23430.8",
                 "size":"0.00283734"
              },
              {
                 "price":"23430.7",
                 "size":"0.1947357"
              },
              {
                 "price":"23430.6",
                 "size":"0.00283734"
              },
              {
                 "price":"23430.5",
                 "size":"0.00283734"
              },
              {
                 "price":"23430.4",
                 "size":"0.00776164"
              },
              {
                 "price":"23430.3",
                 "size":"0.45716168"
              },
              {
                 "price":"23430.2",
                 "size":"0.00283734"
              },
              {
                 "price":"23430.1",
                 "size":"0.00283734"
              },
              {
                 "price":"23430",
                 "size":"0.06283734"
              },
              {
                 "price":"23429.9",
                 "size":"0.00283734"
              },
              {
                 "price":"23429.8",
                 "size":"0.42688319"
              },
              {
                 "price":"23429.7",
                 "size":"0.43541896"
              },
              {
                 "price":"23429.6",
                 "size":"0.00283734"
              },
              {
                 "price":"23429.1",
                 "size":"0.19561285"
              },
              {
                 "price":"23427.8",
                 "size":"0.21352473"
              },
              {
                 "price":"23426.8",
                 "size":"0.00170623"
              },
              {
                 "price":"23426.7",
                 "size":"0.00477744"
              },
              {
                 "price":"23424.6",
                 "size":"0.00042671"
              },
              {
                 "price":"23424.5",
                 "size":"0.41967763"
              },
              {
                 "price":"23424.4",
                 "size":"0.37944469"
              },
              {
                 "price":"23423.2",
                 "size":"0.3086119"
              },
              {
                 "price":"23422.3",
                 "size":"0.05"
              },
              {
                 "price":"23421.8",
                 "size":"0.384093"
              },
              {
                 "price":"23421.7",
                 "size":"0.1"
              },
              {
                 "price":"23420.5",
                 "size":"0.1"
              },
              {
                 "price":"23419.8",
                 "size":"0.1"
              },
              {
                 "price":"23419.6",
                 "size":"0.00237918"
              },
              {
                 "price":"23419.4",
                 "size":"0.0364917"
              },
              {
                 "price":"23418.7",
                 "size":"0.05267"
              },
              {
                 "price":"23418.4",
                 "size":"0.04058811"
              },
              {
                 "price":"23418.3",
                 "size":"0.00699999"
              },
              {
                 "price":"23417.4",
                 "size":"0.40302095"
              },
              {
                 "price":"23417.3",
                 "size":"3.33046331"
              },
              {
                 "price":"23415.5",
                 "size":"0.76945766"
              },
              {
                 "price":"23415.3",
                 "size":"0.1"
              },
              {
                 "price":"23415",
                 "size":"0.05"
              },
              {
                 "price":"23414.8",
                 "size":"0.12"
              },
              {
                 "price":"23414.7",
                 "size":"0.04455095"
              },
              {
                 "price":"23414.4",
                 "size":"0.42668305"
              },
              {
                 "price":"23414.1",
                 "size":"0.11140342"
              },
              {
                 "price":"23413.5",
                 "size":"0.8"
              },
              {
                 "price":"23412.5",
                 "size":"1.54318615"
              },
              {
                 "price":"23412.2",
                 "size":"0.00053383"
              },
              {
                 "price":"23411.9",
                 "size":"1.28101114"
              },
              {
                 "price":"23411.8",
                 "size":"0.00203431"
              },
              {
                 "price":"23411.7",
                 "size":"0.91792938"
              },
              {
                 "price":"23411.4",
                 "size":"0.1333"
              },
              {
                 "price":"23411.2",
                 "size":"0.00237918"
              },
              {
                 "price":"23410.2",
                 "size":"0.61334276"
              },
              {
                 "price":"23409.6",
                 "size":"0.04455782"
              },
              {
                 "price":"23406.2",
                 "size":"0.00038412"
              },
              {
                 "price":"23404.8",
                 "size":"8.80654155"
              },
              {
                 "price":"23404.7",
                 "size":"1.7077215"
              },
              {
                 "price":"23403.4",
                 "size":"0.21346175"
              },
              {
                 "price":"23402.8",
                 "size":"0.00001149"
              },
              {
                 "price":"23402.2",
                 "size":"0.001139"
              },
              {
                 "price":"23400",
                 "size":"0.97571454"
              },
              {
                 "price":"23399.9",
                 "size":"1.75049125"
              },
              {
                 "price":"23399.5",
                 "size":"0.00237918"
              },
              {
                 "price":"23398.8",
                 "size":"2.47689959"
              },
              {
                 "price":"23398",
                 "size":"0.00938"
              },
              {
                 "price":"23396.5",
                 "size":"0.12822427"
              },
              {
                 "price":"23395",
                 "size":"0.42674678"
              },
              {
                 "price":"23394.1",
                 "size":"0.002226"
              },
              {
                 "price":"23392.1",
                 "size":"0.00002573"
              },
              {
                 "price":"23390.2",
                 "size":"0.42668305"
              },
              {
                 "price":"23390.1",
                 "size":"1.20004195"
              },
              {
                 "price":"23390",
                 "size":"0.0000123"
              },
              {
                 "price":"23389.8",
                 "size":"0.01710143"
              },
              {
                 "price":"23389.4",
                 "size":"3.73142099"
              },
              {
                 "price":"23389.2",
                 "size":"0.12826391"
              },
              {
                 "price":"23388.3",
                 "size":"0.59985791"
              },
              {
                 "price":"23387.9",
                 "size":"0.25618691"
              },
              {
                 "price":"23386",
                 "size":"0.00015891"
              },
              {
                 "price":"23385.5",
                 "size":"0.00035065"
              },
              {
                 "price":"23385",
                 "size":"0.00096688"
              },
              {
                 "price":"23384.8",
                 "size":"0.00004584"
              },
              {
                 "price":"23384.3",
                 "size":"0.00033083"
              },
              {
                 "price":"23384",
                 "size":"0.00622025"
              },
              {
                 "price":"23383.8",
                 "size":"0.00007005"
              },
              {
                 "price":"23383",
                 "size":"0.00034176"
              },
              {
                 "price":"23382",
                 "size":"0.00092958"
              },
              {
                 "price":"23381.3",
                 "size":"0.00006844"
              },
              {
                 "price":"23381",
                 "size":"0.00583398"
              },
              {
                 "price":"23380.1",
                 "size":"0.00009534"
              },
              {
                 "price":"23380",
                 "size":"0.00242517"
              },
              {
                 "price":"23379.6",
                 "size":"0.00013879"
              },
              {
                 "price":"23379",
                 "size":"0.00021653"
              },
              {
                 "price":"23378.7",
                 "size":"1.4446308"
              },
              {
                 "price":"23378",
                 "size":"0.00155977"
              },
              {
                 "price":"23377",
                 "size":"0.00090662"
              },
              {
                 "price":"23376.8",
                 "size":"0.00007011"
              },
              {
                 "price":"23376.5",
                 "size":"8.01182659"
              },
              {
                 "price":"23375.9",
                 "size":"0.2562779"
              },
              {
                 "price":"23368.2",
                 "size":"0.03"
              },
              {
                 "price":"23360.9",
                 "size":"0.0004267"
              },
              {
                 "price":"23333.9",
                 "size":"0.32019263"
              },
              {
                 "price":"23308.5",
                 "size":"0.02763625"
              },
              {
                 "price":"23279.9",
                 "size":"0.96039348"
              },
              {
                 "price":"23231.9",
                 "size":"1.92151672"
              },
              {
                 "price":"23207.6",
                 "size":"1.280374"
              },
              {
                 "price":"23183.9",
                 "size":"1.92151672"
              },
              {
                 "price":"23150",
                 "size":"0.10930787"
              },
              {
                 "price":"23081.4",
                 "size":"0.00042551"
              },
              {
                 "price":"22728.2",
                 "size":"0.00164564"
              },
              {
                 "price":"22000",
                 "size":"10.344533"
              },
              {
                 "price":"1",
                 "size":"72182.02321219"
              }
           ],
           "asks":[
              {
                 "price":"23431.2",
                 "size":"0.79999323"
              },
              {
                 "price":"23431.3",
                 "size":"0.00283734"
              },
              {
                 "price":"23431.4",
                 "size":"0.00283734"
              },
              {
                 "price":"23431.5",
                 "size":"0.00283734"
              },
              {
                 "price":"23431.6",
                 "size":"0.00283734"
              },
              {
                 "price":"23431.7",
                 "size":"0.39367085"
              },
              {
                 "price":"23431.8",
                 "size":"0.00283734"
              },
              {
                 "price":"23431.9",
                 "size":"0.00283734"
              },
              {
                 "price":"23432",
                 "size":"0.00283734"
              },
              {
                 "price":"23432.1",
                 "size":"0.00283734"
              },
              {
                 "price":"23432.2",
                 "size":"0.00283734"
              },
              {
                 "price":"23432.3",
                 "size":"0.00283734"
              },
              {
                 "price":"23432.4",
                 "size":"0.00283734"
              },
              {
                 "price":"23432.5",
                 "size":"0.00283734"
              },
              {
                 "price":"23432.9",
                 "size":"0.38383614"
              },
              {
                 "price":"23434.6",
                 "size":"0.00396218"
              },
              {
                 "price":"23434.7",
                 "size":"0.4014609"
              },
              {
                 "price":"23435",
                 "size":"0.1146175"
              },
              {
                 "price":"23435.4",
                 "size":"0.05812603"
              },
              {
                 "price":"23435.5",
                 "size":"0.30141693"
              },
              {
                 "price":"23435.6",
                 "size":"0.55046074"
              },
              {
                 "price":"23437.8",
                 "size":"0.01"
              },
              {
                 "price":"23437.9",
                 "size":"0.079"
              },
              {
                 "price":"23438.2",
                 "size":"0.12"
              },
              {
                 "price":"23438.4",
                 "size":"0.42701196"
              },
              {
                 "price":"23438.5",
                 "size":"2.47689959"
              },
              {
                 "price":"23438.7",
                 "size":"0.16"
              },
              {
                 "price":"23439.4",
                 "size":"1.54318615"
              },
              {
                 "price":"23439.9",
                 "size":"0.02"
              },
              {
                 "price":"23440.9",
                 "size":"0.08491537"
              },
              {
                 "price":"23441.1",
                 "size":"0.00086"
              },
              {
                 "price":"23441.2",
                 "size":"0.14119599"
              },
              {
                 "price":"23442.7",
                 "size":"0.06398575"
              },
              {
                 "price":"23443.6",
                 "size":"0.05"
              },
              {
                 "price":"23443.7",
                 "size":"6.28860381"
              },
              {
                 "price":"23444.2",
                 "size":"0.484089"
              },
              {
                 "price":"23444.7",
                 "size":"0.02495"
              },
              {
                 "price":"23445.3",
                 "size":"0.00237918"
              },
              {
                 "price":"23446",
                 "size":"0.9644144"
              },
              {
                 "price":"23446.2",
                 "size":"0.00699999"
              },
              {
                 "price":"23446.5",
                 "size":"0.05"
              },
              {
                 "price":"23446.8",
                 "size":"0.91575127"
              },
              {
                 "price":"23446.9",
                 "size":"0.05350603"
              },
              {
                 "price":"23447",
                 "size":"0.09455169"
              },
              {
                 "price":"23447.2",
                 "size":"0.3086119"
              },
              {
                 "price":"23447.7",
                 "size":"0.02899996"
              },
              {
                 "price":"23448",
                 "size":"1.28095645"
              },
              {
                 "price":"23448.8",
                 "size":"0.2072678"
              },
              {
                 "price":"23451.3",
                 "size":"0.8"
              },
              {
                 "price":"23451.9",
                 "size":"0.08911358"
              },
              {
                 "price":"23452.8",
                 "size":"1.70761948"
              },
              {
                 "price":"23452.9",
                 "size":"0.0383408"
              },
              {
                 "price":"23454.9",
                 "size":"3.73142099"
              },
              {
                 "price":"23455.8",
                 "size":"0.61334276"
              },
              {
                 "price":"23456.4",
                 "size":"0.21346084"
              },
              {
                 "price":"23457.5",
                 "size":"0.30060355"
              },
              {
                 "price":"23457.6",
                 "size":"0.42670854"
              },
              {
                 "price":"23457.7",
                 "size":"0.33988243"
              },
              {
                 "price":"23458.5",
                 "size":"0.9248746"
              },
              {
                 "price":"23461.1",
                 "size":"0.76945766"
              },
              {
                 "price":"23461.3",
                 "size":"8.01177311"
              },
              {
                 "price":"23461.4",
                 "size":"0.76667845"
              },
              {
                 "price":"23462.4",
                 "size":"0.42674314"
              },
              {
                 "price":"23462.8",
                 "size":"0.00019556"
              },
              {
                 "price":"23463.2",
                 "size":"8.80654155"
              },
              {
                 "price":"23463.6",
                 "size":"0.00144489"
              },
              {
                 "price":"23463.8",
                 "size":"0.00048997"
              },
              {
                 "price":"23465.8",
                 "size":"0.0105925"
              },
              {
                 "price":"23467.2",
                 "size":"0.01468122"
              },
              {
                 "price":"23469",
                 "size":"0.00108007"
              },
              {
                 "price":"23469.1",
                 "size":"0.00852185"
              },
              {
                 "price":"23469.5",
                 "size":"0.00005129"
              },
              {
                 "price":"23470.2",
                 "size":"0.93603286"
              },
              {
                 "price":"23470.9",
                 "size":"1.2"
              },
              {
                 "price":"23471.8",
                 "size":"0.000505"
              },
              {
                 "price":"23472",
                 "size":"0.25616231"
              },
              {
                 "price":"23473",
                 "size":"0.00008287"
              },
              {
                 "price":"23473.2",
                 "size":"1.4196308"
              },
              {
                 "price":"23474",
                 "size":"0.00008587"
              },
              {
                 "price":"23474.1",
                 "size":"0.00013865"
              },
              {
                 "price":"23474.6",
                 "size":"0.0001836"
              },
              {
                 "price":"23475",
                 "size":"0.00008076"
              },
              {
                 "price":"23475.2",
                 "size":"0.00013202"
              },
              {
                 "price":"23475.4",
                 "size":"1"
              },
              {
                 "price":"23481",
                 "size":"0.00057721"
              },
              {
                 "price":"23481.2",
                 "size":"0.01703491"
              },
              {
                 "price":"23482.7",
                 "size":"0.00010421"
              },
              {
                 "price":"23483",
                 "size":"0.01229581"
              },
              {
                 "price":"23483.2",
                 "size":"0.00166542"
              },
              {
                 "price":"23483.4",
                 "size":"15.69306409"
              },
              {
                 "price":"23484",
                 "size":"0.25618071"
              },
              {
                 "price":"23484.9",
                 "size":"0.0091148"
              },
              {
                 "price":"23485.5",
                 "size":"0.00017"
              },
              {
                 "price":"23486.5",
                 "size":"0.00019536"
              },
              {
                 "price":"23488",
                 "size":"0.0014503"
              },
              {
                 "price":"23488.9",
                 "size":"0.00212866"
              },
              {
                 "price":"23489",
                 "size":"0.02556109"
              },
              {
                 "price":"23489.4",
                 "size":"1.5"
              },
              {
                 "price":"23489.7",
                 "size":"0.00048943"
              },
              {
                 "price":"23490",
                 "size":"0.00418974"
              },
              {
                 "price":"23492",
                 "size":"0.00114824"
              },
              {
                 "price":"23492.6",
                 "size":"0.00107898"
              },
              {
                 "price":"23492.8",
                 "size":"0.00018786"
              },
              {
                 "price":"23493.5",
                 "size":"0.6"
              },
              {
                 "price":"23495",
                 "size":"0.08460165"
              },
              {
                 "price":"23496",
                 "size":"0.04554316"
              },
              {
                 "price":"23497",
                 "size":"0.00465174"
              },
              {
                 "price":"23522.4",
                 "size":"0.0004628"
              },
              {
                 "price":"23526",
                 "size":"0.33059078"
              },
              {
                 "price":"23548.8",
                 "size":"1.57699765"
              },
              {
                 "price":"23616",
                 "size":"2.52011712"
              },
              {
                 "price":"23654",
                 "size":"1.28432921"
              },
              {
                 "price":"23783.2",
                 "size":"0.0004244"
              }
           ],
           "timestamp":"2023-02-28T13:13:49.123407Z"
        }
     }
    "#,
        br#"
        {
            "type":"Update",
            "payload":{
              "instrument":{
                "symbol":{
                  "type":"Spot",
                  "payload":{
                      "base":{"code":"BTC"},"quote":{"code":"USDT"}}
                  }, 
                "exchange":"KUCOIN_SPOT"
              },
              "bids":[{"price":"23431.1","size":"2.39595497"}],
              "asks":[],
              "timestamp":"2023-02-28T13:13:49.305789Z"
            }
          }
        "#,
    ];
    let actual = snapshots(messages(MESSAGES))
        .try_collect::<Vec<_>>()
        .await
        .unwrap();
    assert_eq!();
}

fn messages(ms: &[&[u8]]) -> impl Stream<Item = Vec<u8>> {
    snapshots(stream::iter())
}
